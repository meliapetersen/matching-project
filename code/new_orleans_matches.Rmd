---
title: "new_orleans_matches"
author: "Jaesa Rogers"
date: "12/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set( message=F, warning=F, fig.width=12, fig.height=12 )
```


```{r}
# need this installed to use
# genetic matching option in MatchIt
# install.packages("rgenoud")

# load package 
library( MatchIt )
library( here )
library( dplyr )
library( geojsonio )
library( sp )
library( pander )
```


## STEP 01

Load a catalog of URLs of dorling cartograms for each CBSA metro area in the US. 

```{r}
load_crosswalk <- function( )
{
   dorlings.url <- "https://raw.githubusercontent.com/meliapetersen/matching-project/master/data/cbsa-names-and-shapefiles.csv"
   dorlings.catalog <- read.csv( dorlings.url )
   return( dorlings.catalog )
}


```

Load a dorling cartogram for one metro area: 

```{r}
get_dorling <- function( cbsa, dorlings.catalog=NULL, mapit=FALSE )
{

   if( is.null(dorlings.catalog) ){ dorlings.catalog <- load_crosswalk() }


   file.name <- dorlings.catalog$shapefile[ dorlings.catalog$cbsa == cbsa ]
 

   base.url <- "https://raw.githubusercontent.com/DS4PS/usa-dorling-shapefiles/master/maps/metros-dorling/"

   full.url <- paste0( base.url, file.name )

   map <- geojsonio::geojson_read( x=full.url,  what="sp" )

   if( mapit ){ plot( map ) }

   return( map )
   
}
```

Test the function with New Orleans data: 

```{r}
new.orleans.cbsa.code <- 35380
new.orleans <- get_dorling( cbsa=new.orleans.cbsa.code )
```


## STEP 02

Load the treatment data: 

```{r}
df.treatment <- read.csv("rodeod-treatment-data.csv")

```


Add the treatment data to the dorling spatial object: 

```{r}
add_treatment <- function( df.treatment, dorling.object )
{

  # merge leftjoin
  dorling.object <- merge( dorling.object, df.treatment, by.x="GEOID", by.y="id2", all.x=TRUE )


  # dorling.object <- df2
  # x <- c( 1, NA, NA, 1, NA, NA )
  # 
  # omit NAs
  treatment <- dorling.object$treatment 
  treatment[ is.na(treatment) ] <- 0
  dorling.object$treatment <- treatment
 
  # row.names(df.rodeo.metro) <- df.rodeo.metro$id2    
  # df.rodeo.metro <- na.omit( df.rodeo.metro )

  return( dorling.object )
}
```



Test the function:

```{r}
new.orleans <- add_treatment( df.treatment, dorling.object=new.orleans ) 

```


## STEP 03

Match the "treated" census tracts (those that received federal aid) with *equivalent* untreated tracts using the matchit package.


```{r}
match_tracts <- function( fo, dorling.object )
{
   # extract data frame from sp object
   # rename rows using tract IDs
   
   df <- as.data.frame( dorling.object )
   row.names(df) <- df$GEOID
   
   # convert string to formula object
   fo <- as.formula( fo )
   
   matchit.object <- NULL

   # find matches in dataframe based on Household income, college education, and whiteness 
   try( 
      
      invisible({ capture.output({ 
         
      matchit.object <- matchit( fo, 
                        method="genetic", discard="both", reestimate=TRUE,
                        replace=FALSE, caliper=.25, data = df )
      })  }),
      
      
      silent=TRUE )

   return( matchit.object )

}
```

Test the function: 

```{r}
# define the matching function formula 
fo <- as.formula( "treatment ~ own00" )

new.orleans.matches <- 
   match_tracts( fo, new.orleans ) 

summary( new.orleans.matches )
```