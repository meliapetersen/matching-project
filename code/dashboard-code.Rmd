---
title: "Matching Dashboard"
output: 
  flexdashboard::flex_dashboard:
    source: embed
    smart: false
runtime: shiny
---

```{r global, include=FALSE}
library( flexdashboard )
library( tidyverse )
library( ggmap )
library( leaflet )
library( viridis )
library( shiny )
library( DT )
library( pander )
library( knitr )
library( rsconnect )

URL <- "https://github.com/DS4PS/Data-Science-Class/blob/master/DATA/TempeTrafficAccidents.rds?raw=true"
dat <- readRDS(gzcon(url( URL )))

dat <- na.omit(dat) # omit any rows with NAs
dat$fatal <- dat$Totalfatalities > 0 
dat$inj <- dat$Totalinjuries > 0 & dat$Totalfatalities == 0
dat$nohurt <- dat$Totalfatalities + dat$Totalinjuries == 0

date.vec   <- strptime( dat$DateTime, format="%m/%d/%y %H:%M" )
dat$hour   <- format( date.vec, format="%H" ) %>% as.numeric()
dat$month  <- format( date.vec, format="%b" )
dat$day    <- format( date.vec, format="%a" )
dat$day365 <- format( date.vec, format="%j" )
dat$week   <- format( date.vec, format="%V" )

dat <- 
  dat %>% 
  mutate( time.of.day.1 = case_when( hour >= 6 & hour <= 9 ~ "Morning Commute", 
                                   hour >= 16 & hour <= 19 ~ "Evening Commute", 
                                   hour >= 14 & hour <= 15 ~ "School Pickup", 
                                   hour >= 9 & hour <= 13 ~ "Work", 
                                   hour >= 20 & hour <= 23 ~ "Night", 
                                   hour <= 5 & hour >= 0 ~ "Midnight to Dawn") )

dat <- 
  dat %>% 
  mutate( time.of.day.2 = case_when( hour >= 6 & hour <= 9 ~ "Morning Commute", 
                                   hour >= 16 & hour <= 19 ~ "Evening Commute", 
                                   hour >= 14 & hour <= 15 ~ "School Pickup", 
                                   hour >= 9 & hour <= 13 ~ "Work", 
                                   hour >= 20 & hour <= 23 ~ "Night", 
                                   hour <= 5 & hour >= 0 ~ "Midnight to Dawn") )

dat$harm <- ifelse( dat$Totalinjuries > 0 | dat$Totalfatalities > 0, "Harm", "No Harm" )

dat <- 
  dat %>% 
  mutate( d1.substance = case_when( AlcoholUse_Drv1 == "Alcohol" & 
                                      DrugUse_Drv1 == "No Apparent Influence" ~ "Alcohol", 
                                   AlcoholUse_Drv1 == "No Apparent Influence" & 
                                     DrugUse_Drv1 == "Drugs" ~ "Drugs", 
                                   AlcoholUse_Drv1 == "Alcohol" & 
                                     DrugUse_Drv1 == "Drugs" ~ "Alcohol and Drugs", 
                                   AlcoholUse_Drv1 == "No Apparent Influence" & 
                                     DrugUse_Drv1 == "No Apparent Influence" ~ "No Apparent Influence"))

dat <- 
  dat %>% 
  mutate( d2.substance = case_when( AlcoholUse_Drv2 == "Alcohol" & 
                                      DrugUse_Drv2 == "No Apparent Influence" ~ "Alcohol", 
                                    AlcoholUse_Drv2 == "No Apparent Influence" & 
                                      DrugUse_Drv2 == "Drugs" ~ "Drugs", 
                                    AlcoholUse_Drv2 == "Alcohol" & 
                                      DrugUse_Drv2 == "Drugs" ~ "Alcohol and Drugs", 
                                    AlcoholUse_Drv2 == "No Apparent Influence" & 
                                      DrugUse_Drv2 == "No Apparent Influence" ~ "No Apparent Influence"))

dat$age.cat <- case_when( dat$Age_Drv1 >= 0 & 
                            dat$Age_Drv1 <= 18 ~ "Youth", 
                          dat$Age_Drv1 >= 19 & 
                            dat$Age_Drv1 <= 25 ~ "Young Adult", 
                          dat$Age_Drv1 >= 26 & 
                            dat$Age_Drv1 <= 64 ~ "Adult", 
                          dat$Age_Drv1 >= 65 ~ "Senior")
```



Neighborhood Matches by Census Data
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
checkboxGroupInput("days", label = h3("Day of Week"), 
    choices = list("Monday"    = "Mon", 
                   "Tuesday"   = "Tue", 
                   "Wednesday" = "Wed", 
                   "Thursday"  = "Thu",
                   "Friday"    = "Fri",
                   "Saturday"  = "Sat",
                   "Sunday"    = "Sun" ),
    selected = c("Fri","Sat","Sun"))

sliderInput("hour", label = h3("Time of Day"), 
            min = 0, max = 23, value = c(6, 12))

# parameters

```

   
Outputs
-------------------------------------

### Neighborhood Matches by Census Data


```{r}

#leaflet
renderLeaflet({
  
  days.of.week <- input$days    # vector will all checked values
  start.time <- input$hour[1]   # sliderInput lower value
  end.time  <-  input$hour[2] 
  
  d2 <-
    dat %>%
    filter( day %in% input$days, 
            hour >= start.time & hour <= end.time )
  
  d2$col.vec <- ifelse( d2$nohurt, "gray20", ifelse(d2$inj, "steelblue", "darkorange") )              
    
  point.size <- d2$Totalinjuries + d2$Totalfatalities

  crash.details <- paste0( "Time: ", d2$DateTime, "<br>",
                     "Total Fatalities: ", d2$Totalfatalities, "<br>",
                     "Total Injuries: ", d2$Totalinjuries, "<br>",
                     "Collision type: ", d2$Collisionmanner)
  
  tempe <- leaflet( ) %>% 
              addProviderTiles( "CartoDB.Positron" )  %>%
              setView( lng=-111.9278, lat=33.39951, zoom=13 )
  
  
  addCircles( tempe, lng=d2$Longitude, lat=d2$Latitude,
              fillColor=d2$col.vec, fillOpacity=0.5, 
              stroke=F, radius=50*(1+0.33*point.size),
              popup=crash.details )


})
```   


Executive Summary 
===================================== 



Row 
-------------------------------------

### About this Dashboard 

Data from: XXX

This dashboard uses... 

### Dashboard Author

Melia Petersen, Melia.Petersen@asu.edu, Tempe, AZ
Jaesa Rogers, Jaesa.Rogers@asu.edu, Tempe, AZ 

Row
-------------------------------------

DATA DICTIONARY 


```{r}
URL.dd <- "https://raw.githubusercontent.com/DS4PS/cpp-526-fall-2019/master/labs/final-project/TempeTrafficAccidentsDataDictionary.csv"
data.dictionary <- read.csv( URL.dd, stringsAsFactors=F )

data.dictionary$description <- stringi::stri_trans_general( data.dictionary$description, "latin-ascii" )
data.dictionary %>%
  select( column, description ) %>%
  pander( )
```



Data
=====================================  

```{r}
# library( DT )

these.buttons <- c( 'copy', 'csv', 'pdf', 'print' )

renderDataTable({
  datatable(dat[1:100,], filter='bottom', rownames=FALSE, 
           #options=list( pageLength=5, autoWidth=TRUE ),
           fillContainer=TRUE, 
           style="bootstrap",
           class='table-condensed table-striped',
           extensions = 'Buttons', 
           options=list( dom='Bfrtip', 
                         buttons=these.buttons  ) )
})
```
